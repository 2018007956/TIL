https://smsolutions.slab.com/public/posts/open-stack-%EC%8C%A9%EC%A7%9C-%EC%84%A4%EC%B9%98-part-04-1r4p3yac?shr=8zhpgj1f3a24pu31rsv6dbhc#hc9w0-4-12-reboot > 4.5 hostname 부터 설정
- Date : 2025-09-17 ~ 

네트워크 환경경
![[Pasted image 20250923220143.png]]
### 구축 과정
[Controller]
- MariaDB 구동
	- mysql root passwd : vora
	![[Pasted image 20250917224520.png]]
- RabbitMQ 구동
	- user : openstack, pw: dkensxhflektm (아둔토리다스)
	![[Pasted image 20250917225012.png]]
- Memcached 실행
	![[Pasted image 20250917225329.png]]
- openstack 설치
1. Keystone 
	- 기초 DB 내용 생성 (Keystone DB를 Populate) 
		![[Pasted image 20250917230222.png|200]]
	- Nova, Glance, Cinder 등이 사용할 운영용 Project 생성
		![[Pasted image 20250917230940.png|400]]
	- 컨테이너 만들어볼 환경을 위한 Project 생성 : ongojishin
	- openstack을 사용할 때 쓰는 user 생성
		![[Pasted image 20250917231254.png|400]]
2. Glance
	![[Pasted image 20250917232522.png|400]]
	- endpoint
		![[Pasted image 20250917233632.png]]
	- 기초 DB 내용 생성 (Glance DB를 Populate)
		![[Pasted image 20250917233833.png|200]]
	- Glance-api 시작
		![[Pasted image 20250917234055.png]]
	- test - 이미지 다운받고 등록 잘 되는지 테스트 (성공)
		![[Pasted image 20250918013925.png]]		
3. Placement
	- DB 생성
		![[Pasted image 20250918174300.png|200]]
	Placement는 별도의 프로세스가 아니라, Apache2에 연동되어 구동하는 Apache의 Python module
4. Nova
	cell0 DB 생성 확인
	![[Pasted image 20250918203129.png]]
	[Compute] iscsid 기동
	![[Pasted image 20250918204317.png|500]]

5. Neutron
	[Compute]
	- ovs 시작 및 설정
		1. Compute Node의 OpenvSwitch가 Control Node를 바라보도록 설정
		2. Geneve 통신을 할 VTEP 인터페이스 IP를 넣어줌 (이번 실습에서는 Geneve 인터페이스가 없어서 MGMT IP 넣어줌)
		3. Provider 네트워크를 사용하기 위해 br-ex 생성/phynet1에 매칭/nic(enp6s18)을 br-ex와 연동
			> 여기서 "ssh 연결 끊기는 오류 발생"
			- **원인 : 브리지 생성과 NIC 연결 과정에서 기존 IP가 이동/사라짐** 
				- br-ex 브리지 생성하고 물리 NIC(enp6s18)를 브리지에 연결하는 순간, 해당 NIC에 설정된 IP가 브리지로 이동하게 됨
				- 만약 ssh 세션이 enp6s18의 기존 IP로 접속 중이었다면, 브리지를 만들면서 NIC의 IP가 사라지거나 변경되어 세션이 끊길 수 있다
				![[Pasted image 20250919201750.png]]
			- **해결 과정**
				1. 물리 NIC에서 IP 제거 : ip addr flush dev enp6s18
				2. 브리지에 IP 유지 : 
					- ip addr add 192.168.50.122/24 dev br-ex
					- ip link set br-ex up
				3. 브리지와 NIC 연결 확인 : brctl show br-ex 또는 ovs-vsctl show
					![[Pasted image 20250919204612.png|200]]
		4. openvswitch 및 다른 Agent들을 시작
		5. OVN-Controller가 OpenvSwitch와 통신할 수 있도록 OpenvSwitch의 로컬 포트를 엶
		[Controller]
		Compute Node가 잘 추가 되었는지 확인
		![[Pasted image 20250919211024.png|300]]

6. CInder
	- LVM 볼륨 기반의 iSCSI를 구성
		![[Pasted image 20250919215005.png|300]]
		> 추가 하드디스크 필요한 상황
		![[Pasted image 20250922194452.png|300]]
		sdb1 디스크 추가
		
	- PV, VG 생성
		![[Pasted image 20250922194420.png|500]]
	
	[Controller] Cinder-volume이 제대로 보이는지 확인
	![[Pasted image 20250922195221.png]]

6. Horizon
	https://wale.tistory.com/entry/6-%EC%98%A4%ED%94%88%EC%8A%A4%ED%83%9D-horizon-%EC%84%A4%EC%B9%98
	- 접속 URL : [controller IP]/horizon 
## OpenStack 자원 초기 구성
### OpenStack CLI 환경 구성
venv 생성 후 Python 패키지 설치
### 리눅스 기반 이미지 다운로드
간단한 VM 생성에는 cirros 이미지 사용
- qcow2 타입인 이미지파일을 raw 형태로 convert
- 이미지 등록
### 네트워크 구성
[Controller] OpenStack VM이 사용할 네트워크를 Neutron을 통해 생성
- phynet1 스위치를 사용하여 Flat 타입의 Provider network 생성
	![[Pasted image 20250922195847.png]]
- 네트워크 대역대(subnet) 등록
	![[Pasted image 20250922200029.png|400]]
- Security Group 생성
- Flavor(네트워크 리소스의 용량과 구성을 정의하는 매개변수 집합) 생성
## VM 생성
Cloud-init Config
![[Pasted image 20250922200756.png]]


##### Status : ERROR
로컬 디스크 VM 
Cinder 볼륨 연동형 VM
![[Pasted image 20250922201526.png]]
> Networks 컬럼이 비어 있음 -> 인스턴스가 아직 IP를 할당받지 못한 상태
![[Pasted image 20250922224949.png|400]]
![[Pasted image 20250922225017.png]]
- 에러 메시지 : Fault: Host 'os-compute' is not mapped to any cell
- **문제 원인**
	`os-compute`라는 호스트가 OpenStack **Cell DB에 매핑되어 있지 않아서** Nova가 인스턴스를 어느 Cell에 배치해야 할지 몰라 `error` 상태가 나는 상황
- **해결 과정**
	1. Cell에 Compute 매핑 확인
			`sudo nova-manage cell_v2 list_cells`
	2. Compute 노드 매핑
			`sudo nova-manage cell_v2 discover_hosts`
	3. Compute 상태 확인
		`openstack compute service list`
	4. Nova 재시작
		`sudo systemctl restart nova-api nova-scheduler nova-conductor`
## 구축 성공?
![[Pasted image 20250922224816.png]]![[Pasted image 20250922224823.png|400]]

>Status : Active지만, ssh 연결이나 ping이 안되는 상황

**상황 분석**
- 라우터는 내부 서브넷과 외부 네트워크 사이의 게이트웨이 역할을 함
- 라우터가 physical network와 제대로 연결되어 있어야 외부에서 인스턴스로 ssh가 도달할 수 있음
OpenStack에서 인스턴스 네트워크 구조
`[인스턴스] --- (VM network) --- [private router] --- (public network / physical network) --- 인터넷`

**문제 분석**
라우터 연결 확인을 해보면,
![[Pasted image 20250922232644.png]]
`external_gateway_info` 항목에 physical/public network가 연결되어 있어야 한다.
연결이 안 되어 있으면 Floating IP를 붙여도 외부에서 접근이 불가하다.

**해결 과정**
1. External Network 생성 : `/etc/neutron/plugins/ml2/ml2_conf.ini`
	![[Pasted image 20250922234601.png]]
2. OVS 브리지 매핑 : `/etc/neutron/plugins/ml2/openvswitch_agent.ini`
	```
	[ovs]
	bridge_mappings = phynet1:br-ex,phynet2:br-ex
	```
3. Neutron agent 재시작
	 `systemctl restart neutron-server.service`
4. flat 타입 external network 생성
	![[Pasted image 20250922234722.png|500]]
	(근데 이렇게 두 개의 phynet을 같은 브리지(br-ex)에 매핑하면, flat 네트워크에서는 충돌이 난다고 함 // TroubleShooting 기록 참고)
5. External Network에 Subnet 생성(해야 Floating IP 배포 가능)
	![[Pasted image 20250923002218.png|500]]
	- 물리 네트워크 장치와 연결되는 external network의 gateway는 실제 라우터 IP와 일치해야 NAT와 Floating IP 연결이 정상적으로 동작한다
	- 따라서, 실제 gateway주소로 public-subnet을 생성함
6. 라우터와 연결
	`openstack router set private-router --external-gateway public-network`
	![[Pasted image 20250923004749.png|400]]
7. Floating IP 생성 및 연결
	```
	openstack floating ip create public-network
	openstack server add floating ip <INSTANCE_NAME> <FLOATING_IP>
	```
##### Error : router_gateway down
> 라우터와 연결되는 주소에 ping이 안먹히는 상황
> router_gateway status down
![[Pasted image 20250923230205.png|400]]

**해결 과정**
[Compute] 노드에서 라우터를 외부망이랑 바인딩 했더니,
`sudo ovs-vsctl set Open_vSwitch . external_ids:ovn-cms-options="enable-chassis-as-gw"`
![[Pasted image 20250923225740.png]]
- security group에 아래 두 개 추가되고, router_gateway Active 뜸
	![[Pasted image 20250923231035.png|400]]

> 그런데 router_gateway status = Active 됐는데도, ping 안 됨


## SSH TEST
