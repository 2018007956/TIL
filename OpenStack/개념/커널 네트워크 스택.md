커널 네트워크 스택(Kernel Network Stack)은
리눅스 커널 내부에서 패킷이 NIC ↔ 사용자 프로그램 사이를 이동할 때 거치는  
**IP/TCP/ARP/라우팅/필터링 전 과정을 처리하는 계층 구조**이다
## Stack
여기서 Stack은 **계층 구조**를 뜻한다
리눅스 커널의 네트워킹은 OSI 7계층과 비슷하게 계층적으로 구성되어 있다.

==커널 네트워크 스택 = 커널 내부에서 네트워크 패킷이 통과하는 계층적 경로==

## 전체 구조도
```
┌───────────────────────────┐
│        사용자 공간         │
│  ├── ssh, curl, ping 등   │
│  ├── OpenStack API, nginx │
└────────────┬──────────────┘
             │ (시스템 콜)
             ▼
┌─────────────────────────────────┐
│        커널 공간                 │
│  ┌─ Socket Layer (소켓 계층)     │
│  ├─ TCP / UDP Layer (전송 계층)  │
│  ├─ IP Layer (네트워크 계층)     │
│  ├─ ARP / ICMP / Routing        │
│  ├─ Netfilter / NAT / QoS       │
│  ├─ Device Driver (NIC, OVS 등) │
└────────────┬────────────────────┘  
             ▼
┌──────────────────────────┐
│       네트워크 카드(NIC)  │
│       (eth0, enp6s18 등) │
└──────────────────────────┘
```

## 주요 구성요소
| 계층                       | 역할                 | 예시                               |
| ------------------------ | ------------------ | -------------------------------- |
| **소켓 계층 (Socket Layer)** | 사용자 공간 프로세스와 커널 연결 | `socket()`, `bind()`, `listen()` |
| **전송 계층 (TCP/UDP)**      | 연결 관리, 신뢰성 보장      | `TCP handshake`, `UDP datagram`  |
| **네트워크 계층 (IP)**         | 라우팅, IP 헤더 처리      | `ip route`, `ip rule`            |
| **링크 계층 (L2)**           | MAC 주소, 브리지, VLAN  | `br-ex`, `vlan`, `bond`          |
| **드라이버 계층**              | NIC 제어, DMA 전송     | `enp6s18`, `eth0`                |
| **Netfilter 계층**         | 방화벽/NAT 관리         | `iptables`, `nftables`           |
## 패킷 이동 경로
SSH 요청을 받는 과정을 보면,

1. **NIC(enp6s18)**  
    → 외부에서 들어온 전기 신호(패킷)를 받음
2. **Device Driver**  
    → NIC 드라이버가 패킷을 커널로 전달
3. **커널 네트워크 스택**  
    → IP 레벨에서 목적지를 판단하고, TCP 레벨에서 연결을 식별
4. **소켓 계층(Socket Layer)**  
    → `sshd` 프로세스에 전달
5. **User Space**  
    → `sshd`가 실제로 세션을 처리 (로그인 등)

즉, NIC가 받는 패킷은 항상 커널 네트워크 스택을 통과해야만
유저 프로세스(ssh, ngix, etc)에 도달할 수 있다.

## 브리지가 개입하면?
일반적인 NIC → 커널 네트워크 스택 경로는 다음과 같다
```
[외부] → NIC(enp6s18) → 커널 네트워크 스택(IP, TCP, 소켓) → sshd
```

그런데 브리지를 만들고 NIC를 `br-ex`에 붙이면
```
[외부] → NIC(enp6s18) → br-ex(OVS 커널 모듈에서 스위칭) → patch-int → br-int → VM 또는 OVN 논리 네트워크
```
패킷이 커널의 일반적인 네트워크 스택을 거치지 않고, OVS의 커널 모듈이 직접 처리해버린다.

`br-ex`가 스위치처럼 작동하면서 enp6s18(물리 포트)로 들어온 트래픽을
`patch-int`라는 가상 포트를 통해 내부 네트워크(`br-int`)로 전달한다.

즉, 커널이 IP레벨에서 라우팅하거나 SSH 트래픽을 받아들이기 전에 
OVS가 "이건 브리지 내부 트래픽이야"라고 판단해서,
다른 포트로 넘기거나 드롭해버릴 수 있다.

그래서 브리지에 관리용 NIC를 잘못 붙이면
커널 네트워크 스택이 그 NIC로 들어오는 패킷을 더 이상 직접 보지 못하게 되어 
SSH가 끊겨버리는 것

([[localnet 포트 세팅 후 서버 전체 통신 끊김 현상]] 참고)