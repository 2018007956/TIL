## 필수 과제
- server list는 아래와 같이 한정된 값만 출력을 해주고 있습니다.![image](https://forum.openinfra-kr.org/uploads/default/optimized/1X/f8059fda3b95744ff523217ff78ac00a98b98057_2_690x76.jpeg)
 - 위 결과값에 project name , user name을 포함시켜서 출력되게 해주세요.
### 해결 과정
`python-openstackclient\openstackclient\compute\v2\server.py` 
ListServer.take_action() : server list 결과값을 만드는 함수
-> bp 걸어서 리턴값 확인
![[Pasted image 20250731124441.png]]
table은 column_headers, s, columns 등으로 구성된 것을 확인할 수 있음

추가하고 싶은 column_headers, columns를 구성
```python
columns += ('project_name', 'user_name')
column_headers += ('Project Name', 'User Name')
```

값을 어떻게 추가해야 할지 알아보기 위해, take_action 코드 분석
```python
def take_action(self, parsed_args):
	# OpenStack SDK에서 가져오기 위한 인스턴스를 생성
	compute_client = self.app.client_manager.compute # compute를 담당하는 nova의 SDK를 참조
	identity_client = self.app.client_manager.identity
	image_client = self.app.client_manager.image
	
	...
	data = list(compute_client.servers(**search_opts))
	...
	
	# 실제로 데이터가 들어가는 부분
	for s in data:
		...
		s.image_id = s.image['id']
		...
```

data를 출력해보면 서버 하나 당 하나의 객체가 출력되는 것을 볼 수 있음

project와 user는 인증과 관련되는 부분이기 때문에 identity_client에 정보 넣어줌

```python
for s in data:
	if s.project_id:
		s.project_name = identity_client.projects.get(s.project_id).name
	else:
		s.project_name = 'N/A'

	if s.user_id:
		s.user_name = identity_client.users.get(s.user_id).name
	else:
		s.user_name = 'N/A'
```
### 출력 결과
![[Pasted image 20250727233150.png]]
## 선택 과제
- openstack server list를 입력했을 때 take_action()함수를 찾아가는 과정 분석해보기
`python-openstackclient/openstackclient/shell.py`에서 `['server', 'list']`를 받아 OpenStackShell().run()에 넘겨준다

```python
def run(self, argv: list[str]) -> int:
        ret_val = 1
        self.command_options = argv
        try:
            ret_val = super().run(argv)
            return ret_val
	...
```

부모 클래스(app.App)의 run 함수로 인자를 넘겨준다
`Lib/site-packages/cliff/app.py` App

>OpenStack Cliff는 OpenStack 프로젝트에서 사용하는 커맨드 라인 인터페이스 (CLI) 프레임워크이다. 즉, OpenStack 서비스를 관리하고 상호 작용하기 위한 명령줄 도구를 쉽게 만들 수 있도록 해주는 도구이다.

```python
# shell.py
class OpenStackShell(app.App):
	...
    def initialize_app(self, argv: list[str]) -> None:
        super().initialize_app(argv)
	...
```

```python
class App:
	def __init__(
        self,
        description: str | None,
        version: str | None,
        command_manager: '_commandmanager.CommandManager',
        ...
    ) -> None:
        """Initialize the application."""
        self.command_manager = command_manager
        ...
        
	def run(self, argv: list[str]) -> int:
		...
		self.initialize_app(remainder)
		...
```

`OpenStackShell` 앱을 생성하고 실행한다.

```python
# Lib/site-packages/cliff/commandmanager.py
class CommanManager:
	...
    def find_command(
        self, argv: list[str]
        ...
            if found:
                cmd_ep = self.commands[found]
                if hasattr(cmd_ep, 'resolve'):
                    cmd_factory = cmd_ep.resolve()
                else:
                    # NOTE(dhellmann): Some fake classes don't take
                    # require as an argument. Yay?
                    arg_spec = inspect.getfullargspec(cmd_ep.load)
                    if 'require' in arg_spec[0]:
                        cmd_factory = cmd_ep.load(require=False)
                    else:
                        cmd_factory = cmd_ep.load()
                return (cmd_factory, return_name, search_args)
        ...
```

`run_subcommand` 메서드 내부에서 `cliff.commandmanager.CommandManager`의 인스턴스인 `self.command_manager`를 사용하여 `find_command`를 호출하고, 인자로 넘어온 `['server', 'list']`에 해당하는 ListServer 클래스를 찾아낸다.

`run_subcommand` 메서드가 `find_command`를 통해 찾아낸 `cmd_factory`인 `ListServer` 클래스를 사용하여 `cmd = cmd_factory()`를 통해 인스턴스를 생성한다.

```python
# Lib/site-packages/cliff/command.py
class Command(metaclass=abc.ABCMeta):
    def run(self, parsed_args: argparse.Namespace) -> int:
        """Invoked by the application when the command is run.

        Developers implementing commands should override
        :meth:`take_action`.

        Developers creating new command base classes (such as
        :class:`Lister` and :class:`ShowOne`) should override this
        method to wrap :meth:`take_action`.

        Return the value returned by :meth:`take_action` or 0.
        """
        parsed_args = self._run_before_hooks(parsed_args)
        return_code = self.take_action(parsed_args) or 0
        return_code = self._run_after_hooks(parsed_args, return_code)
        return return_code
```

ListServer를 포함한 모든 명령어 클래스의 부모 클래스인 `/cliff/command.py`의 `run()` 메서드가 `self.take_action(parsed_args)`를 호출함으로써, 실제 로직이 담긴 메서드로 연결된다.

```python
# python-openstackclient/openstackclient/compute/v2/server.py
class ListServer(command.Lister):
    _description = _("List servers")
    ...
     def take_action(self, parsed_args):
     ...
```

따라서 최종적으로 `python-openstackclient/openstackclient/compute/v2/server.py`의 `ListServer` 클래스의 `take_action` 메서드가 호출된된다.